"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const Hash_1 = __importDefault(global[Symbol.for('ioc.use')]("Adonis/Core/Hash"));
const index_1 = require("./../../database/factories/index");
const Database_1 = __importDefault(global[Symbol.for('ioc.use')]("Adonis/Lucid/Database"));
const luxon_1 = require("luxon");
const japa_1 = __importDefault(require("japa"));
const supertest_1 = __importDefault(require("supertest"));
const Mail_1 = __importDefault(global[Symbol.for('ioc.use')]("Adonis/Addons/Mail"));
const BASE_URL = `http://${process.env.HOST}:${process.env.PORT}`;
japa_1.default.group('Password', (group) => {
    (0, japa_1.default)('it should send and email with forgot password instructions', async (assert) => {
        const user = await index_1.UserFactory.create();
        Mail_1.default.trap((message) => {
            assert.deepEqual(message.to, [
                {
                    address: user.email,
                },
            ]);
            assert.deepEqual(message.from, {
                address: 'no-reply@roleplay.com',
            });
            assert.equal(message.subject, 'Roleplay: recuperação de Senha');
            assert.include(message.html, user.username);
        });
        await (0, supertest_1.default)(BASE_URL)
            .post('/forgot-password')
            .send({
            email: user.email,
            resetPasswordUrl: 'url',
        })
            .expect(204);
        Mail_1.default.restore();
    });
    (0, japa_1.default)('it should create a reset password token', async (assert) => {
        const user = await index_1.UserFactory.create();
        await (0, supertest_1.default)(BASE_URL)
            .post('/forgot-password')
            .send({
            email: user.email,
            resetPasswordUrl: 'url',
        })
            .expect(204);
        const tokens = await user.related('tokens').query();
        assert.isNotEmpty(tokens);
    }).timeout(4000);
    (0, japa_1.default)('it should return 422 when required data is not provided or data is invalid', async (assert) => {
        const { body } = await (0, supertest_1.default)(BASE_URL).post('/forgot-password').send({}).expect(422);
        assert.equal(body.code, 'BAD_REQUEST');
        assert.equal(body.status, 422);
    });
    (0, japa_1.default)('it should be able to reset password', async (assert) => {
        const user = await index_1.UserFactory.create();
        const { token } = await user.related('tokens').create({ token: 'token' });
        await (0, supertest_1.default)(BASE_URL)
            .post('/reset-password')
            .send({ token, password: '123456' })
            .expect(204);
        await user.refresh();
        const checkPassword = await Hash_1.default.verify(user.password, '123456');
        assert.isTrue(checkPassword);
    });
    (0, japa_1.default)('it should return 422 when error reset password', async (assert) => {
        const { body } = await (0, supertest_1.default)(BASE_URL).post('/reset-password').send({}).expect(422);
        assert.equal(body.code, 'BAD_REQUEST');
        assert.equal(body.status, 422);
    });
    (0, japa_1.default)('it should retiurn 404 when usin the same token twice', async (assert) => {
        const user = await index_1.UserFactory.create();
        const { token } = await user.related('tokens').create({ token: 'token' });
        await (0, supertest_1.default)(BASE_URL)
            .post('/reset-password')
            .send({ token, password: '123456' })
            .expect(204);
        const { body } = await (0, supertest_1.default)(BASE_URL)
            .post('/reset-password')
            .send({ token, password: '123456' })
            .expect(404);
        assert.equal(body.code, 'BAD_REQUEST');
        assert.equal(body.status, 404);
    });
    (0, japa_1.default)('it cannot reset password when token is expired after 2 hours', async (assert) => {
        const user = await index_1.UserFactory.create();
        const date = luxon_1.DateTime.now().minus(luxon_1.Duration.fromISOTime('02:01'));
        const { token } = await user.related('tokens').create({ token: 'token', createdAt: date });
        const { body } = await (0, supertest_1.default)(BASE_URL)
            .post('/reset-password')
            .send({ token, password: '123456' })
            .expect(410);
        assert.equal(body.code, 'TOKEN_EXPIRED');
        assert.equal(body.status, 410);
        assert.equal(body.message, 'token has expired');
    });
    group.beforeEach(async () => {
        await Database_1.default.beginGlobalTransaction();
    });
    group.afterEach(async () => {
        await Database_1.default.rollbackGlobalTransaction();
    });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGFzc3dvcmRzLnNwZWMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJwYXNzd29yZHMuc3BlYy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUFBLGtGQUF3QztBQUN4Qyw0REFBOEQ7QUFDOUQsMkZBQWlEO0FBQ2pELGlDQUEwQztBQUMxQyxnREFBdUI7QUFDdkIsMERBQWlDO0FBQ2pDLG9GQUEwQztBQUUxQyxNQUFNLFFBQVEsR0FBRyxVQUFVLE9BQU8sQ0FBQyxHQUFHLENBQUMsSUFBSSxJQUFJLE9BQU8sQ0FBQyxHQUFHLENBQUMsSUFBSSxFQUFFLENBQUE7QUFFakUsY0FBSSxDQUFDLEtBQUssQ0FBQyxVQUFVLEVBQUUsQ0FBQyxLQUFLLEVBQUUsRUFBRTtJQUMvQixJQUFBLGNBQUksRUFBQyw0REFBNEQsRUFBRSxLQUFLLEVBQUUsTUFBTSxFQUFFLEVBQUU7UUFDbEYsTUFBTSxJQUFJLEdBQUcsTUFBTSxtQkFBVyxDQUFDLE1BQU0sRUFBRSxDQUFBO1FBRXZDLGNBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxPQUFPLEVBQUUsRUFBRTtZQUNwQixNQUFNLENBQUMsU0FBUyxDQUFDLE9BQU8sQ0FBQyxFQUFFLEVBQUU7Z0JBQzNCO29CQUNFLE9BQU8sRUFBRSxJQUFJLENBQUMsS0FBSztpQkFDcEI7YUFDRixDQUFDLENBQUE7WUFDRixNQUFNLENBQUMsU0FBUyxDQUFDLE9BQU8sQ0FBQyxJQUFJLEVBQUU7Z0JBQzdCLE9BQU8sRUFBRSx1QkFBdUI7YUFDakMsQ0FBQyxDQUFBO1lBQ0YsTUFBTSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsT0FBTyxFQUFFLGdDQUFnQyxDQUFDLENBQUE7WUFDL0QsTUFBTSxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsSUFBSyxFQUFFLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQTtRQUM5QyxDQUFDLENBQUMsQ0FBQTtRQUVGLE1BQU0sSUFBQSxtQkFBUyxFQUFDLFFBQVEsQ0FBQzthQUN0QixJQUFJ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Q0FBQyxHQUFHLEVBQUUsQ0FBQyxLQUFLLENBQUMsZ0JBQVEsQ0FBQyxXQUFXLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQTtRQUNoRSxNQUFNLEVBQUUsS0FBSyxFQUFFLEdBQUcsTUFBTSxJQUFJLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxFQUFFLEtBQUssRUFBRSxPQUFPLEVBQUUsU0FBUyxFQUFFLElBQUksRUFBRSxDQUFDLENBQUE7UUFFMUYsTUFBTSxFQUFFLElBQUksRUFBRSxHQUFHLE1BQU0sSUFBQSxtQkFBUyxFQUFDLFFBQVEsQ0FBQzthQUN2QyxJQUFJLENBQUMsaUJBQWlCLENBQUM7YUFDdkIsSUFBSSxDQUFDLEVBQUUsS0FBSyxFQUFFLFFBQVEsRUFBRSxRQUFRLEVBQUUsQ0FBQzthQUNuQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUE7UUFFZCxNQUFNLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsZUFBZSxDQUFDLENBQUE7UUFDeEMsTUFBTSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsTUFBTSxFQUFFLEdBQUcsQ0FBQyxDQUFBO1FBQzlCLE1BQU0sQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLE9BQU8sRUFBRSxtQkFBbUIsQ0FBQyxDQUFBO0lBQ2pELENBQUMsQ0FBQyxDQUFBO0lBRUYsS0FBSyxDQUFDLFVBQVUsQ0FBQyxLQUFLLElBQUksRUFBRTtRQUMxQixNQUFNLGtCQUFRLENBQUMsc0JBQXNCLEVBQUUsQ0FBQTtJQUN6QyxDQUFDLENBQUMsQ0FBQTtJQUNGLEtBQUssQ0FBQyxTQUFTLENBQUMsS0FBSyxJQUFJLEVBQUU7UUFDekIsTUFBTSxrQkFBUSxDQUFDLHlCQUF5QixFQUFFLENBQUE7SUFDNUMsQ0FBQyxDQUFDLENBQUE7QUFDSixDQUFDLENBQUMsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBIYXNoIGZyb20gJ0Bpb2M6QWRvbmlzL0NvcmUvSGFzaCdcbmltcG9ydCB7IFVzZXJGYWN0b3J5IH0gZnJvbSAnLi8uLi8uLi9kYXRhYmFzZS9mYWN0b3JpZXMvaW5kZXgnXG5pbXBvcnQgRGF0YWJhc2UgZnJvbSAnQGlvYzpBZG9uaXMvTHVjaWQvRGF0YWJhc2UnXG5pbXBvcnQgeyBEYXRlVGltZSwgRHVyYXRpb24gfSBmcm9tICdsdXhvbidcbmltcG9ydCB0ZXN0IGZyb20gJ2phcGEnXG5pbXBvcnQgc3VwZXJ0ZXN0IGZyb20gJ3N1cGVydGVzdCdcbmltcG9ydCBNYWlsIGZyb20gJ0Bpb2M6QWRvbmlzL0FkZG9ucy9NYWlsJ1xuXG5jb25zdCBCQVNFX1VSTCA9IGBodHRwOi8vJHtwcm9jZXNzLmVudi5IT1NUfToke3Byb2Nlc3MuZW52LlBPUlR9YFxuXG50ZXN0Lmdyb3VwKCdQYXNzd29yZCcsIChncm91cCkgPT4ge1xuICB0ZXN0KCdpdCBzaG91bGQgc2VuZCBhbmQgZW1haWwgd2l0aCBmb3Jnb3QgcGFzc3dvcmQgaW5zdHJ1Y3Rpb25zJywgYXN5bmMgKGFzc2VydCkgPT4ge1xuICAgIGNvbnN0IHVzZXIgPSBhd2FpdCBVc2VyRmFjdG9yeS5jcmVhdGUoKVxuXG4gICAgTWFpbC50cmFwKChtZXNzYWdlKSA9PiB7XG4gICAgICBhc3NlcnQuZGVlcEVxdWFsKG1lc3NhZ2UudG8sIFtcbiAgICAgICAge1xuICAgICAgICAgIGFkZHJlc3M6IHVzZXIuZW1haWwsXG4gICAgICAgIH0sXG4gICAgICBdKVxuICAgICAgYXNzZXJ0LmRlZXBFcXVhbChtZXNzYWdlLmZyb20sIHtcbiAgICAgICAgYWRkcmVzczogJ25vLXJlcGx5QHJvbGVwbGF5LmNvbScsXG4gICAgICB9KVxuICAgICAgYXNzZXJ0LmVxdWFsKG1lc3NhZ2Uuc3ViamVjdCwgJ1JvbGVwbGF5OiByZWN1cGVyYcOnw6NvIGRlIFNlbmhhJylcbiAgICAgIGFzc2VydC5pbmNsdWRlKG1lc3NhZ2UuaHRtbCEsIHVzZXIudXNlcm5hbWUpXG4gICAgfSlcblxuICAgIGF3YWl0IHN1cGVydGVzdChCQVNFX1VSTClcbiAgICAgIC5wb3N0KCcvZm9yZ290LXBhc3N3b3JkJylcbiAgICAgIC5zZW5kKHtcbiAgICAgICAgZW1haWw6IHVzZXIuZW1haWwsXG4gICAgICAgIHJlc2V0UGFzc3dvcmRVcmw6ICd1cmwnLFxuICAgICAgfSlcbiAgICAgIC5leHBlY3QoMjA0KVxuXG4gICAgTWFpbC5yZXN0b3JlKClcbiAgfSlcblxuICB0ZXN0KCdpdCBzaG91bGQgY3JlYXRlIGEgcmVzZXQgcGFzc3dvcmQgdG9rZW4nLCBhc3luYyAoYXNzZXJ0KSA9PiB7XG4gICAgY29uc3QgdXNlciA9IGF3YWl0IFVzZXJGYWN0b3J5LmNyZWF0ZSgpXG5cbiAgICBhd2FpdCBzdXBlcnRlc3QoQkFTRV9VUkwpXG4gICAgICAucG9zdCgnL2ZvcmdvdC1wYXNzd29yZCcpXG4gICAgICAuc2VuZCh7XG4gICAgICAgIGVtYWlsOiB1c2VyLmVtYWlsLFxuICAgICAgICByZXNldFBhc3N3b3JkVXJsOiAndXJsJyxcbiAgICAgIH0pXG4gICAgICAuZXhwZWN0KDIwNClcblxuICAgIGNvbnN0IHRva2VucyA9IGF3YWl0IHVzZXIucmVsYXRlZCgndG9rZW5zJykucXVlcnkoKVxuICAgIGFzc2VydC5pc05vdEVtcHR5KHRva2VucylcbiAgfSkudGltZW91dCg0MDAwKVxuXG4gIHRlc3QoJ2l0IHNob3VsZCByZXR1cm4gNDIyIHdoZW4gcmVxdWlyZWQgZGF0YSBpcyBub3QgcHJvdmlkZWQgb3IgZGF0YSBpcyBpbnZhbGlkJywgYXN5bmMgKGFzc2VydCkgPT4ge1xuICAgIGNvbnN0IHsgYm9keSB9ID0gYXdhaXQgc3VwZXJ0ZXN0KEJBU0VfVVJMKS5wb3N0KCcvZm9yZ290LXBhc3N3b3JkJykuc2VuZCh7fSkuZXhwZWN0KDQyMilcbiAgICBhc3NlcnQuZXF1YWwoYm9keS5jb2RlLCAnQkFEX1JFUVVFU1QnKVxuICAgIGFzc2VydC5lcXVhbChib2R5LnN0YXR1cywgNDIyKVxuICB9KVxuXG4gIHRlc3QoJ2l0IHNob3VsZCBiZSBhYmxlIHRvIHJlc2V0IHBhc3N3b3JkJywgYXN5bmMgKGFzc2VydCkgPT4ge1xuICAgIGNvbnN0IHVzZXIgPSBhd2FpdCBVc2VyRmFjdG9yeS5jcmVhdGUoKVxuICAgIGNvbnN0IHsgdG9rZW4gfSA9IGF3YWl0IHVzZXIucmVsYXRlZCgndG9rZW5zJykuY3JlYXRlKHsgdG9rZW46ICd0b2tlbicgfSlcblxuICAgIGF3YWl0IHN1cGVydGVzdChCQVNFX1VSTClcbiAgICAgIC5wb3N0KCcvcmVzZXQtcGFzc3dvcmQnKVxuICAgICAgLnNlbmQoeyB0b2tlbiwgcGFzc3dvcmQ6ICcxMjM0NTYnIH0pXG4gICAgICAuZXhwZWN0KDIwNClcblxuICAgIGF3YWl0IHVzZXIucmVmcmVzaCgpXG4gICAgY29uc3QgY2hlY2tQYXNzd29yZCA9IGF3YWl0IEhhc2gudmVyaWZ5KHVzZXIucGFzc3dvcmQsICcxMjM0NTYnKVxuICAgIGFzc2VydC5pc1RydWUoY2hlY2tQYXNzd29yZClcbiAgfSlcblxuICB0ZXN0KCdpdCBzaG91bGQgcmV0dXJuIDQyMiB3aGVuIGVycm9yIHJlc2V0IHBhc3N3b3JkJywgYXN5bmMgKGFzc2VydCkgPT4ge1xuICAgIGNvbnN0IHsgYm9keSB9ID0gYXdhaXQgc3VwZXJ0ZXN0KEJBU0VfVVJMKS5wb3N0KCcvcmVzZXQtcGFzc3dvcmQnKS5zZW5kKHt9KS5leHBlY3QoNDIyKVxuICAgIGFzc2VydC5lcXVhbChib2R5LmNvZGUsICdCQURfUkVRVUVTVCcpXG4gICAgYXNzZXJ0LmVxdWFsKGJvZHkuc3RhdHVzLCA0MjIpXG4gIH0pXG5cbiAgdGVzdCgnaXQgc2hvdWxkIHJldGl1cm4gNDA0IHdoZW4gdXNpbiB0aGUgc2FtZSB0b2tlbiB0d2ljZScsIGFzeW5jIChhc3NlcnQpID0+IHtcbiAgICBjb25zdCB1c2VyID0gYXdhaXQgVXNlckZhY3RvcnkuY3JlYXRlKClcbiAgICBjb25zdCB7IHRva2VuIH0gPSBhd2FpdCB1c2VyLnJlbGF0ZWQoJ3Rva2VucycpLmNyZWF0ZSh7IHRva2VuOiAndG9rZW4nIH0pXG5cbiAgICBhd2FpdCBzdXBlcnRlc3QoQkFTRV9VUkwpXG4gICAgICAucG9zdCgnL3Jlc2V0LXBhc3N3b3JkJylcbiAgICAgIC5zZW5kKHsgdG9rZW4sIHBhc3N3b3JkOiAnMTIzNDU2JyB9KVxuICAgICAgLmV4cGVjdCgyMDQpXG5cbiAgICBjb25zdCB7IGJvZHkgfSA9IGF3YWl0IHN1cGVydGVzdChCQVNFX1VSTClcbiAgICAgIC5wb3N0KCcvcmVzZXQtcGFzc3dvcmQnKVxuICAgICAgLnNlbmQoeyB0b2tlbiwgcGFzc3dvcmQ6ICcxMjM0NTYnIH0pXG4gICAgICAuZXhwZWN0KDQwNClcblxuICAgIGFzc2VydC5lcXVhbChib2R5LmNvZGUsICdCQURfUkVRVUVTVCcpXG4gICAgYXNzZXJ0LmVxdWFsKGJvZHkuc3RhdHVzLCA0MDQpXG4gIH0pXG5cbiAgdGVzdCgnaXQgY2Fubm90IHJlc2V0IHBhc3N3b3JkIHdoZW4gdG9rZW4gaXMgZXhwaXJlZCBhZnRlciAyIGhvdXJzJywgYXN5bmMgKGFzc2VydCkgPT4ge1xuICAgIGNvbnN0IHVzZXIgPSBhd2FpdCBVc2VyRmFjdG9yeS5jcmVhdGUoKVxuICAgIGNvbnN0IGRhdGUgPSBEYXRlVGltZS5ub3coKS5taW51cyhEdXJhdGlvbi5mcm9tSVNPVGltZSgnMDI6MDEnKSlcbiAgICBjb25zdCB7IHRva2VuIH0gPSBhd2FpdCB1c2VyLnJlbGF0ZWQoJ3Rva2VucycpLmNyZWF0ZSh7IHRva2VuOiAndG9rZW4nLCBjcmVhdGVkQXQ6IGRhdGUgfSlcblxuICAgIGNvbnN0IHsgYm9keSB9ID0gYXdhaXQgc3VwZXJ0ZXN0KEJBU0VfVVJMKVxuICAgICAgLnBvc3QoJy9yZXNldC1wYXNzd29yZCcpXG4gICAgICAuc2VuZCh7IHRva2VuLCBwYXNzd29yZDogJzEyMzQ1NicgfSlcbiAgICAgIC5leHBlY3QoNDEwKVxuXG4gICAgYXNzZXJ0LmVxdWFsKGJvZHkuY29kZSwgJ1RPS0VOX0VYUElSRUQnKVxuICAgIGFzc2VydC5lcXVhbChib2R5LnN0YXR1cywgNDEwKVxuICAgIGFzc2VydC5lcXVhbChib2R5Lm1lc3NhZ2UsICd0b2tlbiBoYXMgZXhwaXJlZCcpXG4gIH0pXG5cbiAgZ3JvdXAuYmVmb3JlRWFjaChhc3luYyAoKSA9PiB7XG4gICAgYXdhaXQgRGF0YWJhc2UuYmVnaW5HbG9iYWxUcmFuc2FjdGlvbigpXG4gIH0pXG4gIGdyb3VwLmFmdGVyRWFjaChhc3luYyAoKSA9PiB7XG4gICAgYXdhaXQgRGF0YWJhc2Uucm9sbGJhY2tHbG9iYWxUcmFuc2FjdGlvbigpXG4gIH0pXG59KVxuIl19