"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const BadRequestException_1 = __importDefault(global[Symbol.for('ioc.use')]("App/Exceptions/BadRequestException"));
const GroupRequest_1 = __importDefault(global[Symbol.for('ioc.use')]("App/Models/GroupRequest"));
const Group_1 = __importDefault(global[Symbol.for('ioc.use')]("App/Models/Group"));
class GroupRequestsController {
    async index({ request, response }) {
        const { master } = request.qs();
        if (!master) {
            throw new BadRequestException_1.default('master query should be provided', 422);
        }
        const groupRequests = await GroupRequest_1.default.query()
            .select('id', 'groupId', 'userId', 'status')
            .preload('group', (query) => {
            query.select('name', 'master');
        })
            .preload('user', (query) => {
            query.select('username');
        })
            .whereHas('group', (query) => {
            query.where('master', Number(master));
        })
            .where('status', 'PENDING');
        return response.ok({ groupRequests });
    }
    async store({ request, response, auth }) {
        const groupId = await request.param('groupId');
        const userId = auth.user.id;
        const existingGroupRequest = await GroupRequest_1.default.query()
            .where('groupId', groupId)
            .andWhere('userId', userId)
            .first();
        if (existingGroupRequest) {
            throw new BadRequestException_1.default('group request already exists', 409);
        }
        const userAlreadyInGroup = await Group_1.default.query()
            .whereHas('players', (query) => {
            query.where('id', userId);
        })
            .andWhere('id', groupId)
            .first();
        if (userAlreadyInGroup) {
            throw new BadRequestException_1.default('user is already in the group', 422);
        }
        const groupRequest = await GroupRequest_1.default.create({ groupId, userId });
        await groupRequest.refresh();
        return response.created({ groupRequest });
    }
    async accept({ request, response, bouncer }) {
        const groupId = request.param('groupId');
        const requestId = request.param('requestId');
        const groupRequest = await GroupRequest_1.default.query()
            .where('id', requestId)
            .andWhere('groupId', groupId)
            .firstOrFail();
        await groupRequest.load('group');
        await bouncer.authorize('acceptGroupRequest', groupRequest);
        const updatedGroupRequest = await groupRequest.merge({ status: 'ACCEPTED' }).save();
        await groupRequest.load('group');
        await groupRequest.group.related('players').attach([groupRequest.userId]);
        return response.ok({ groupRequest: updatedGroupRequest });
    }
    async destroy({ request, response, bouncer }) {
        const groupId = request.param('groupId');
        const requestId = request.param('requestId');
        const groupRequest = await GroupRequest_1.default.query()
            .where('id', requestId)
            .andWhere('groupId', groupId)
            .firstOrFail();
        await groupRequest.load('group');
        await bouncer.authorize('rejectGroupRequest', groupRequest);
        await groupRequest.delete();
        return response.ok({});
    }
}
exports.default = GroupRequestsController;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiR3JvdXBSZXF1ZXN0c0NvbnRyb2xsZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJHcm91cFJlcXVlc3RzQ29udHJvbGxlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUFBLG1IQUEyRDtBQUUzRCxpR0FBa0Q7QUFDbEQsbUZBQW9DO0FBRXBDLE1BQXFCLHVCQUF1QjtJQUNuQyxLQUFLLENBQUMsS0FBSyxDQUFFLEVBQUUsT0FBTyxFQUFFLFFBQVEsRUFBc0I7UUFFM0QsTUFBTSxFQUFFLE1BQU0sRUFBRSxHQUFHLE9BQU8sQ0FBQyxFQUFFLEVBQUUsQ0FBQTtRQUUvQixJQUFJLENBQUMsTUFBTSxFQUFFO1lBQ1gsTUFBTSxJQUFJLDZCQUFVLENBQUMsaUNBQWlDLEVBQUUsR0FBRyxDQUFDLENBQUE7U0FDN0Q7UUFHRCxNQUFNLGFBQWEsR0FBRyxNQUFNLHNCQUFZLENBQUMsS0FBSyxFQUFFO2FBQzdDLE1BQU0sQ0FBQyxJQUFJLEVBQUUsU0FBUyxFQUFFLFFBQVEsRUFBRSxRQUFRLENBQUM7YUFDM0MsT0FBTyxDQUFDLE9BQU8sRUFBRSxDQUFDLEtBQUssRUFBRSxFQUFFO1lBQzFCLEtBQUssQ0FBQyxNQUFNLENBQUMsTUFBTSxFQUFFLFFBQVEsQ0FBQyxDQUFBO1FBQ2hDLENBQUMsQ0FBQzthQUNELE9BQU8sQ0FBQyxNQUFNLEVBQUUsQ0FBQyxLQUFLLEVBQUUsRUFBRTtZQUN6QixLQUFLLENBQUMsTUFBTSxDQUFDLFVBQVUsQ0FBQyxDQUFBO1FBQzFCLENBQUMsQ0FBQzthQUNELFFBQVEsQ0FBQyxPQUFPLEVBQUUsQ0FBQyxLQUFLLEVBQUUsRUFBRTtZQUMzQixLQUFLLENBQUMsS0FBSyxDQUFDLFFBQVEsRUFBRSxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQTtRQUN2QyxDQUFDLENBQUM7YUFDRCxLQUFLLENBQUMsUUFBUSxFQUFFLFNBQVMsQ0FBQyxDQUFBO1FBRTdCLE9BQU8sUUFBUSxDQUFDLEVBQUUsQ0FBQyxF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QUMsS0FBSyxDQUFDLFdBQVcsQ0FBVyxDQUFBO1FBRXRELE1BQU0sWUFBWSxHQUFHLE1BQU0sc0JBQVksQ0FBQyxLQUFLLEVBQUU7YUFDNUMsS0FBSyxDQUFDLElBQUksRUFBRSxTQUFTLENBQUM7YUFDdEIsUUFBUSxDQUFDLFNBQVMsRUFBRSxPQUFPLENBQUM7YUFDNUIsV0FBVyxFQUFFLENBQUE7UUFFaEIsTUFBTSxZQUFZLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFBO1FBQ2hDLE1BQU0sT0FBTyxDQUFDLFNBQVMsQ0FBQyxvQkFBb0IsRUFBRSxZQUFZLENBQUMsQ0FBQTtRQUUzRCxNQUFNLFlBQVksQ0FBQyxNQUFNLEVBQUUsQ0FBQTtRQUUzQixPQUFPLFFBQVEsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUE7SUFDeEIsQ0FBQztDQUNGO0FBM0ZELDBDQTJGQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBCYWRSZXF1ZXN0IGZyb20gJ0FwcC9FeGNlcHRpb25zL0JhZFJlcXVlc3RFeGNlcHRpb24nXG5pbXBvcnQgdHlwZSB7IEh0dHBDb250ZXh0Q29udHJhY3QgfSBmcm9tICdAaW9jOkFkb25pcy9Db3JlL0h0dHBDb250ZXh0J1xuaW1wb3J0IEdyb3VwUmVxdWVzdCBmcm9tICdBcHAvTW9kZWxzL0dyb3VwUmVxdWVzdCdcbmltcG9ydCBHcm91cCBmcm9tICdBcHAvTW9kZWxzL0dyb3VwJ1xuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBHcm91cFJlcXVlc3RzQ29udHJvbGxlciB7XG4gIHB1YmxpYyBhc3luYyBpbmRleCAoeyByZXF1ZXN0LCByZXNwb25zZX06IEh0dHBDb250ZXh0Q29udHJhY3QpIHtcbiAgICAvLyBPIFFTIGJ1c2NhIG9zIHBhcmFtZXRyb3MgcGFzc2Fkb3MgbmEgdXJsXG4gICAgY29uc3QgeyBtYXN0ZXIgfSA9IHJlcXVlc3QucXMoKVxuXG4gICAgaWYgKCFtYXN0ZXIpIHtcbiAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0KCdtYXN0ZXIgcXVlcnkgc2hvdWxkIGJlIHByb3ZpZGVkJywgNDIyKVxuICAgIH1cblxuICAgIC8vIHByZWxvYWQgY2FycmVnYSBvcyByZWxhY2lvbmFtZW50b3MsIHNlbSBlbGUgbsOjb210cmF6IGFzIGluZm9ybWHDp8O1ZXMgZG8gcmVsYWNpb25hbWVudG8gbmEgcXVlcnlcbiAgICBjb25zdCBncm91cFJlcXVlc3RzID0gYXdhaXQgR3JvdXBSZXF1ZXN0LnF1ZXJ5KClcbiAgICAgIC5zZWxlY3QoJ2lkJywgJ2dyb3VwSWQnLCAndXNlcklkJywgJ3N0YXR1cycpXG4gICAgICAucHJlbG9hZCgnZ3JvdXAnLCAocXVlcnkpID0+IHtcbiAgICAgICAgcXVlcnkuc2VsZWN0KCduYW1lJywgJ21hc3RlcicpXG4gICAgICB9KVxuICAgICAgLnByZWxvYWQoJ3VzZXInLCAocXVlcnkpID0+IHtcbiAgICAgICAgcXVlcnkuc2VsZWN0KCd1c2VybmFtZScpXG4gICAgICB9KVxuICAgICAgLndoZXJlSGFzKCdncm91cCcsIChxdWVyeSkgPT4ge1xuICAgICAgICBxdWVyeS53aGVyZSgnbWFzdGVyJywgTnVtYmVyKG1hc3RlcikpXG4gICAgICB9KVxuICAgICAgLndoZXJlKCdzdGF0dXMnLCAnUEVORElORycpXG5cbiAgICByZXR1cm4gcmVzcG9uc2Uub2soeyBncm91cFJlcXVlc3RzIH0pXG4gIH1cbiAgcHVibGljIGFzeW5jIHN0b3JlICh7IHJlcXVlc3QsIHJlc3BvbnNlLCBhdXRofTogSHR0cENvbnRleHRDb250cmFjdCkge1xuICAgIGNvbnN0IGdyb3VwSWQgPSBhd2FpdCByZXF1ZXN0LnBhcmFtKCdncm91cElkJykgYXMgbnVtYmVyXG4gICAgY29uc3QgdXNlcklkID0gYXV0aC51c2VyIS5pZFxuXG4gICAgY29uc3QgZXhpc3RpbmdHcm91cFJlcXVlc3QgPSBhd2FpdCBHcm91cFJlcXVlc3QucXVlcnkoKVxuICAgICAgLndoZXJlKCdncm91cElkJywgZ3JvdXBJZClcbiAgICAgIC5hbmRXaGVyZSgndXNlcklkJywgdXNlcklkKVxuICAgICAgLmZpcnN0KClcblxuICAgIGlmIChleGlzdGluZ0dyb3VwUmVxdWVzdCkge1xuICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3QoJ2dyb3VwIHJlcXVlc3QgYWxyZWFkeSBleGlzdHMnLCA0MDkpXG4gICAgfVxuXG4gICAgY29uc3QgdXNlckFscmVhZHlJbkdyb3VwID0gYXdhaXQgR3JvdXAucXVlcnkoKVxuICAgICAgLndoZXJlSGFzKCdwbGF5ZXJzJywgKHF1ZXJ5KSA9PiB7XG4gICAgICAgIHF1ZXJ5LndoZXJlKCdpZCcsIHVzZXJJZClcbiAgICAgIH0pXG4gICAgICAuYW5kV2hlcmUoJ2lkJywgZ3JvdXBJZClcbiAgICAgIC5maXJzdCgpXG5cbiAgICBpZiAodXNlckFscmVhZHlJbkdyb3VwKSB7XG4gICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdCgndXNlciBpcyBhbHJlYWR5IGluIHRoZSBncm91cCcsIDQyMilcbiAgICB9XG5cbiAgICBjb25zdCBncm91cFJlcXVlc3QgPSBhd2FpdCBHcm91cFJlcXVlc3QuY3JlYXRlKHsgZ3JvdXBJZCwgdXNlcklkIH0pXG4gICAgYXdhaXQgZ3JvdXBSZXF1ZXN0LnJlZnJlc2goKVxuICAgIHJldHVybiByZXNwb25zZS5jcmVhdGVkKHsgZ3JvdXBSZXF1ZXN0IH0pXG4gIH1cblxuICBwdWJsaWMgYXN5bmMgYWNjZXB0ICh7IHJlcXVlc3QsIHJlc3BvbnNlLCBib3VuY2VyIH06IEh0dHBDb250ZXh0Q29udHJhY3QpIHtcbiAgICBjb25zdCBncm91cElkID0gcmVxdWVzdC5wYXJhbSgnZ3JvdXBJZCcpIGFzIG51bWJlclxuICAgIGNvbnN0IHJlcXVlc3RJZCA9IHJlcXVlc3QucGFyYW0oJ3JlcXVlc3RJZCcpIGFzIG51bWJlclxuXG4gICAgY29uc3QgZ3JvdXBSZXF1ZXN0ID0gYXdhaXQgR3JvdXBSZXF1ZXN0LnF1ZXJ5KClcbiAgICAgIC53aGVyZSgnaWQnLCByZXF1ZXN0SWQpXG4gICAgICAuYW5kV2hlcmUoJ2dyb3VwSWQnLCBncm91cElkKVxuICAgICAgLmZpcnN0T3JGYWlsKClcblxuICAgIGF3YWl0IGdyb3VwUmVxdWVzdC5sb2FkKCdncm91cCcpXG4gICAgYXdhaXQgYm91bmNlci5hdXRob3JpemUoJ2FjY2VwdEdyb3VwUmVxdWVzdCcsIGdyb3VwUmVxdWVzdClcblxuICAgIGNvbnN0IHVwZGF0ZWRHcm91cFJlcXVlc3QgPSBhd2FpdCBncm91cFJlcXVlc3QubWVyZ2UoeyBzdGF0dXM6ICdBQ0NFUFRFRCcgfSkuc2F2ZSgpXG5cbiAgICAvLyBObyBsdWNpZCBzZW1wcmUgw6kgbmVjZXNzw6FyaW8gY2FycmVnYXIgYXMgaW5mb3JtYcOnw7VlcyBjb20gbyBvIFwibG9hZFwiXG4gICAgYXdhaXQgZ3JvdXBSZXF1ZXN0LmxvYWQoJ2dyb3VwJylcbiAgICBhd2FpdCBncm91cFJlcXVlc3QuZ3JvdXAucmVsYXRlZCgncGxheWVycycpLmF0dGFjaChbZ3JvdXBSZXF1ZXN0LnVzZXJJZF0pXG5cbiAgICByZXR1cm4gcmVzcG9uc2Uub2soeyBncm91cFJlcXVlc3Q6IHVwZGF0ZWRHcm91cFJlcXVlc3QgfSlcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBkZXN0cm95ICh7IHJlcXVlc3QsIHJlc3BvbnNlLCBib3VuY2VyIH06IEh0dHBDb250ZXh0Q29udHJhY3QpIHtcbiAgICBjb25zdCBncm91cElkID0gcmVxdWVzdC5wYXJhbSgnZ3JvdXBJZCcpIGFzIG51bWJlclxuICAgIGNvbnN0IHJlcXVlc3RJZCA9IHJlcXVlc3QucGFyYW0oJ3JlcXVlc3RJZCcpIGFzIG51bWJlclxuXG4gICAgY29uc3QgZ3JvdXBSZXF1ZXN0ID0gYXdhaXQgR3JvdXBSZXF1ZXN0LnF1ZXJ5KClcbiAgICAgIC53aGVyZSgnaWQnLCByZXF1ZXN0SWQpXG4gICAgICAuYW5kV2hlcmUoJ2dyb3VwSWQnLCBncm91cElkKVxuICAgICAgLmZpcnN0T3JGYWlsKClcblxuICAgIGF3YWl0IGdyb3VwUmVxdWVzdC5sb2FkKCdncm91cCcpXG4gICAgYXdhaXQgYm91bmNlci5hdXRob3JpemUoJ3JlamVjdEdyb3VwUmVxdWVzdCcsIGdyb3VwUmVxdWVzdClcblxuICAgIGF3YWl0IGdyb3VwUmVxdWVzdC5kZWxldGUoKVxuXG4gICAgcmV0dXJuIHJlc3BvbnNlLm9rKHt9KVxuICB9XG59XG4iXX0=